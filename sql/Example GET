GO

IF NOT EXISTS (SELECT * FROM information_schema.tables WHERE table_name = 'Test1') 
BEGIN
CREATE TABLE Test1 (
    guid UNIQUEIDENTIFIER PRIMARY KEY,
    senderId NVARCHAR(MAX),
    recipientId NVARCHAR(MAX),
    shipmentType NVARCHAR(MAX), 
    globalShipmentNumber NVARCHAR(MAX) 
);
END;

--oauth2
DECLARE @OutputString NVARCHAR(MAX);
EXEC [dbo].[GetKey] '11', '22', @OutputString OUTPUT;

--GET
DECLARE @Result INT, @Status INT = 1, @StatusText VARCHAR(100), @ResponseText NVARCHAR(MAX), @PostData NVARCHAR(MAX), @AuthHeader NVARCHAR(MAX), @UrlString NVARCHAR(MAX)
SELECT  @UrlString = 'https://localhost:44372/'
SELECT @AuthHeader =  @OutputString;

EXEC    @Result = dbo.usp_sys_InvokeWebService 'GET', @UrlString, @Timeout = 5
                        , @Status = @Status OUTPUT, @StatusText = @StatusText OUTPUT, @ResponseText = @ResponseText OUTPUT, @AuthHeader = @AuthHeader
SELECT  @Result AS Result, @Status AS Status, @StatusText AS StatusText, @ResponseText AS ResponseText

--Saving data from get request to database 
IF @Result = 0
BEGIN
INSERT INTO Test1 (guid, senderId, recipientId, shipmentType, globalShipmentNumber)
SELECT 
    JSON_VALUE(@ResponseText, '$.id') AS guid,
    JSON_VALUE(@ResponseText, '$.senderId') AS senderId,
    JSON_VALUE(@ResponseText, '$.recipientId') AS recipientId,
    JSON_VALUE(@ResponseText, '$.shipmentType') AS shipmentType,
    JSON_VALUE(@ResponseText, '$.globalShipmentNumber') AS globalShipmentNumber;
END